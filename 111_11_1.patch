Subject: [PATCH] 111
11
1
---
Index: src/CloudlogHelper/Services/RigctldService.cs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CloudlogHelper/Services/RigctldService.cs b/src/CloudlogHelper/Services/RigctldService.cs
--- a/src/CloudlogHelper/Services/RigctldService.cs	(revision 278eb9078e93474b616267b5803041ec0d2882d0)
+++ b/src/CloudlogHelper/Services/RigctldService.cs	(revision f909e597bc891ca3e38542baa06fdb27c36b3306)
@@ -3,6 +3,7 @@
 using System.Collections.Generic;
 using System.Diagnostics;
 using System.Linq;
+using System.Net;
 using System.Net.Sockets;
 using System.Text;
 using System.Threading;
@@ -41,13 +42,19 @@
     {
         try
         {
+            if (_tcpClient is not null)
+            {
+                var endPoint = (IPEndPoint)_tcpClient.Client.RemoteEndPoint!;
+                if (_tcpClient.Connected && !IPAddress.IsLoopback(endPoint.Address)) return true;
+            }
+           
             return 
                 (_backgroundProcess?.HasExited == false) || 
                 (_onetimeProcess?.HasExited == false);
         }
         catch (InvalidOperationException)
         {
-            StopServiceSync();
+            // StopServiceSync();
             return false;
         }
     }
Index: src/CloudlogHelper/Services/Interfaces/IRigBackendManager.cs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CloudlogHelper/Services/Interfaces/IRigBackendManager.cs b/src/CloudlogHelper/Services/Interfaces/IRigBackendManager.cs
--- a/src/CloudlogHelper/Services/Interfaces/IRigBackendManager.cs	(revision 3d18975e0c9d167508dd0a7eaa99d2cfc5382bef)
+++ b/src/CloudlogHelper/Services/Interfaces/IRigBackendManager.cs	(revision f909e597bc891ca3e38542baa06fdb27c36b3306)
@@ -11,6 +11,7 @@
     Task InitializeAsync();
 
     RigBackendServiceEnum GetServiceType();
+    string GetServiceEndpointAddress();
     IRigService GetServiceByName(RigBackendServiceEnum rigBackend);
 
     bool IsServiceRunning();
Index: src/CloudlogHelper/Services/Interfaces/IUdpServerService.cs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CloudlogHelper/Services/Interfaces/IUdpServerService.cs b/src/CloudlogHelper/Services/Interfaces/IUdpServerService.cs
--- a/src/CloudlogHelper/Services/Interfaces/IUdpServerService.cs	(revision 3d18975e0c9d167508dd0a7eaa99d2cfc5382bef)
+++ b/src/CloudlogHelper/Services/Interfaces/IUdpServerService.cs	(revision f909e597bc891ca3e38542baa06fdb27c36b3306)
@@ -9,6 +9,8 @@
 
 public interface IUdpServerService
 {
+    string GetUdpBindingAddress();
+    
     bool IsUdpServerEnabled();
     
     bool IsUdpServerRunning();
Index: src/CloudlogHelper/Services/RigBackendManager.cs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CloudlogHelper/Services/RigBackendManager.cs b/src/CloudlogHelper/Services/RigBackendManager.cs
--- a/src/CloudlogHelper/Services/RigBackendManager.cs	(revision 3d18975e0c9d167508dd0a7eaa99d2cfc5382bef)
+++ b/src/CloudlogHelper/Services/RigBackendManager.cs	(revision 7fbcc6f7564010c48dbaa58b3d8b0c92c39e0869)
@@ -1,5 +1,6 @@
 using System;
 using System.Collections.Generic;
+using System.Linq;
 using System.Text.RegularExpressions;
 using System.Threading;
 using System.Threading.Tasks;
@@ -30,95 +31,157 @@
     private IRigService _currentService;
     private bool _initialized;
     private readonly Dictionary<RigBackendServiceEnum, IRigService> _services = new();
+    
+    private PollingSettingsCache _settingsCache;
+    private DateTime _lastSettingsUpdate = DateTime.MinValue;
+    
+    private class PollingSettingsCache
+    {
+        public bool HamlibPollAllowed { get; set; }
+        public bool FLRigPollAllowed { get; set; }
+        public bool OmniRigPollAllowed { get; set; }
+        public int HamlibPollInterval { get; set; }
+        public int FLRigPollInterval { get; set; }
+        public int OmniRigPollInterval { get; set; }
+        public DateTime CacheTime { get; set; }
+    }
 
     public RigBackendManager(IEnumerable<IRigService> rigSources, IApplicationSettingsService appSettingsService)
     {
         _appSettings = appSettingsService.GetCurrentSettings();
-        foreach (var rigService in rigSources) _services[rigService.GetServiceType()] = rigService;
+        foreach (var rigService in rigSources) 
+            _services[rigService.GetServiceType()] = rigService;
+        
+        // Initialize cache
+        UpdateSettingsCache();
         
         // bind settings change
-        MessageBus.Current.Listen<SettingsChanged>().Subscribe(async void (x) =>
+        MessageBus.Current.Listen<SettingsChanged>().Subscribe(async (x) =>
         {
             try
             {
-                var currentRigService = _getCurrentRigService();
-                if (currentRigService.GetServiceType() != _currentService?.GetServiceType())
-                {
-                    _currentService = currentRigService;
-                    await _currentService?.StopService(_getNewCancellationProcessToken())!;
-                }
+                await HandleSettingsChanged(x);
+            }
+            catch (Exception e)
+            {
+                ClassLogger.Error(e,"Error while switching rig services.");
+            }
+        });
+    }
+
+    private async Task HandleSettingsChanged(SettingsChanged x)
+    {
+        var currentRigService = _getCurrentRigService();
+        
+        // Only stop service if service type actually changed
+        if (currentRigService.GetServiceType() != _currentService?.GetServiceType())
+        {
+            await StopCurrentService();
+            _currentService = currentRigService;
+        }
+
+        // Use dictionary for service handling to avoid repetitive switch
+        var serviceHandlers = new Dictionary<ChangedPart, Func<Task>>
+        {
+            [ChangedPart.NothingJustClosed] = HandleNothingJustClosed,
+            [ChangedPart.Hamlib] = () => HandleHamlibSettings(currentRigService),
+            [ChangedPart.FLRig] = () => HandleFLRigSettings(currentRigService),
+            [ChangedPart.OmniRig] = () => HandleOmniRigSettings(currentRigService)
+        };
+
+        if (serviceHandlers.TryGetValue(x.Part, out var handler))
+        {
+            await handler();
+        }
+        
+        // Update cache after settings change
+        UpdateSettingsCache();
+    }
 
-                switch (x.Part)
-                {
-                    case ChangedPart.NothingJustClosed:
-                        // close all services, if not available.
-                        if (!_appSettings.HamlibSettings.PollAllowed)
-                            await _services[RigBackendServiceEnum.Hamlib].StopService(_getNewCancellationProcessToken());
-                        if (!_appSettings.FLRigSettings.PollAllowed)
-                            await _services[RigBackendServiceEnum.FLRig].StopService(_getNewCancellationProcessToken());
-                        if (!_appSettings.OmniRigSettings.PollAllowed)
-                            if (_services.TryGetValue(RigBackendServiceEnum.OmniRig, out var value))
-                            {
-                                await value.StopService(_getNewCancellationProcessToken());
-                            }
-                        break;
-                    
-                    case ChangedPart.Hamlib:
-                        if (_currentService.GetServiceType() != RigBackendServiceEnum.Hamlib) break;
+    private async Task HandleNothingJustClosed()
+    {
+        var tasks = new List<Task>();
+        
+        if (!_appSettings.HamlibSettings.PollAllowed)
+            tasks.Add(_services[RigBackendServiceEnum.Hamlib].StopService(_getNewCancellationProcessToken()));
+        
+        if (!_appSettings.FLRigSettings.PollAllowed)
+            tasks.Add(_services[RigBackendServiceEnum.FLRig].StopService(_getNewCancellationProcessToken()));
+        
+        if (!_appSettings.OmniRigSettings.PollAllowed && 
+            _services.TryGetValue(RigBackendServiceEnum.OmniRig, out var omniRigService))
+        {
+            tasks.Add(omniRigService.StopService(_getNewCancellationProcessToken()));
+        }
+        
+        await Task.WhenAll(tasks);
+    }
+
+    private async Task HandleHamlibSettings(IRigService currentRigService)
+    {
+        if (currentRigService.GetServiceType() != RigBackendServiceEnum.Hamlib) 
+            return;
 
-                        // if (_appSettingsService.RestartHamlibNeeded())
-                        // {
-                            await _currentService.StopService(_getNewCancellationProcessToken());
-                            if (_appSettings.HamlibSettings.UseExternalRigctld) break;
+        await _currentService.StopService(_getNewCancellationProcessToken());
+        if (_appSettings.HamlibSettings.UseExternalRigctld) 
+            return;
 
-                            if (_appSettings.HamlibSettings.PollAllowed)
-                            {
-                                _syncRigInfoAddr.Clear();
-                                _syncRigInfoAddr.AddRange(_appSettings.HamlibSettings.SyncRigInfoAddress.Split(";"));
-                                await _startRigctld();
-                            }
-                        // }
+        if (_appSettings.HamlibSettings.PollAllowed)
+        {
+            _syncRigInfoAddr.Clear();
+            _syncRigInfoAddr.AddRange(_appSettings.HamlibSettings.SyncRigInfoAddress.Split(";"));
+            await _startRigctld();
+        }
+    }
 
-                        break;
-
-                    case ChangedPart.FLRig:
-                        if (_currentService.GetServiceType() != RigBackendServiceEnum.FLRig) break;
+    private async Task HandleFLRigSettings(IRigService currentRigService)
+    {
+        if (currentRigService.GetServiceType() != RigBackendServiceEnum.FLRig) 
+            return;
 
-                        if (_appSettings.FLRigSettings.PollAllowed)
-                        {
-                            _syncRigInfoAddr.Clear();
-                            _syncRigInfoAddr.AddRange(_appSettings.HamlibSettings.SyncRigInfoAddress.Split(";"));
-                        }
+        if (_appSettings.FLRigSettings.PollAllowed)
+        {
+            _syncRigInfoAddr.Clear();
+            _syncRigInfoAddr.AddRange(_appSettings.HamlibSettings.SyncRigInfoAddress.Split(";"));
+        }
+    }
 
-                        break;
-                    case ChangedPart.OmniRig:
-                        if (_currentService.GetServiceType() != RigBackendServiceEnum.OmniRig) break;
-                        // await _currentService.StopService(_getNewCancellationProcessToken());
-                        if (_appSettings.OmniRigSettings.PollAllowed)
-                        {
-                            _syncRigInfoAddr.Clear();
-                            _syncRigInfoAddr.AddRange(_appSettings.OmniRigSettings.SyncRigInfoAddress.Split(";"));
-                            await _currentService.StartService(_getNewCancellationProcessToken(),_appSettings.OmniRigSettings.SelectedRig);
-                        }
-                        break;
-                }
-            }
-            catch (Exception e)
-            {
-                ClassLogger.Error(e,"Error while switching rig services.");
-            }
-        });
+    private async Task HandleOmniRigSettings(IRigService currentRigService)
+    {
+        if (currentRigService.GetServiceType() != RigBackendServiceEnum.OmniRig) 
+            return;
+
+        if (_appSettings.OmniRigSettings.PollAllowed)
+        {
+            _syncRigInfoAddr.Clear();
+            _syncRigInfoAddr.AddRange(_appSettings.OmniRigSettings.SyncRigInfoAddress.Split(";"));
+            await _currentService.StartService(_getNewCancellationProcessToken(), _appSettings.OmniRigSettings.SelectedRig);
+        }
+    }
+
+    private async Task StopCurrentService()
+    {
+        if (_currentService != null)
+        {
+            await _currentService.StopService(_getNewCancellationProcessToken());
+        }
     }
 
     public void Dispose()
     {
         _appSettings.Dispose();
+        
+        _syncRigInfoAddr.Clear();
+        _services.Clear();
+        
+        GC.SuppressFinalize(this);
     }
 
     public async Task InitializeAsync()
     {
         if (_initialized) return;
         _initialized = true;
+        
         // select default service on start...
         _currentService = _services[RigBackendServiceEnum.Hamlib];
         try
@@ -140,13 +203,16 @@
             {
                 _syncRigInfoAddr.AddRange(_appSettings.OmniRigSettings.SyncRigInfoAddress.Split(";"));
                 _currentService = _services[RigBackendServiceEnum.OmniRig];
-                await _currentService.StartService(_getNewCancellationProcessToken(),_appSettings.OmniRigSettings.SelectedRig);
+                await _currentService.StartService(_getNewCancellationProcessToken(), _appSettings.OmniRigSettings.SelectedRig);
             }
         }
         catch (Exception ex)
         {
             ClassLogger.Error(ex, "Error while initing rig service");
         }
+        
+        // Initialize cache
+        UpdateSettingsCache();
     }
 
     public RigBackendServiceEnum GetServiceType()
@@ -154,6 +220,39 @@
         return _currentService.GetServiceType();
     }
 
+    public string GetServiceEndpointAddress()
+    {
+        try
+        {
+            return _currentService.GetServiceType() switch
+            {
+                RigBackendServiceEnum.Hamlib => GetHamlibEndpoint(),
+                RigBackendServiceEnum.FLRig => $"({_appSettings.FLRigSettings.FLRigHost}:{_appSettings.FLRigSettings.FLRigPort})",
+                RigBackendServiceEnum.OmniRig => $"({_appSettings.OmniRigSettings.SelectedRig})",
+                _ => throw new ArgumentOutOfRangeException()
+            };
+        }
+        catch (Exception ex)
+        {
+            ClassLogger.Warn(ex, "Unable to read service endpoint.");
+            return "(?)";
+        }
+    }
+
+    private string GetHamlibEndpoint()
+    {
+        try
+        {
+            var (rigctldIp, rigctldPort) = _getRigctldIpAndPort();
+            return $"{rigctldIp}:{rigctldPort}";
+        }
+        catch (Exception ex)
+        {
+            ClassLogger.Warn(ex, "Unable to read hamlib endpoint.");
+            return "(?)";
+        }
+    }
+
     public IRigService GetServiceByName(RigBackendServiceEnum rigBackend)
     {
         return _services[rigBackend];
@@ -199,67 +298,122 @@
 
     public async Task<RadioData> GetAllRigInfo()
     {
-        var appSettingsHamlibSettings = _appSettings.HamlibSettings;
-        var appSettingsFLRigSettings = _appSettings.FLRigSettings;
-        var appSettingsOmniSettings = _appSettings.OmniRigSettings;
+        return await GetAllRigInfo(CancellationToken.None);
+    }
+
+    public async Task<RadioData> GetAllRigInfo(CancellationToken cancellationToken)
+    {
+        // Create a settings snapshot to avoid repeated property access
+        var settingsSnapshot = new
+        {
+            Hamlib = _appSettings.HamlibSettings,
+            FLRig = _appSettings.FLRigSettings,
+            OmniRig = _appSettings.OmniRigSettings,
+            ServiceType = _currentService.GetServiceType()
+        };
 
         RadioData data;
-        switch (_currentService.GetServiceType())
+        
+        try
         {
-            case RigBackendServiceEnum.Hamlib:
-                if (!appSettingsHamlibSettings.PollAllowed)
-                    throw new InvalidPollException("Poll disabled.");
+            data = await GetRigDataForService(settingsSnapshot, cancellationToken);
+            
+            // Fire-and-forget for sync operations with error handling
+            if (!cancellationToken.IsCancellationRequested && _syncRigInfoAddr.Any())
+            {
+                _ = Task.Run(async () =>
+                {
+                    foreach (var address in _syncRigInfoAddr.Where(addr => !string.IsNullOrWhiteSpace(addr)))
+                    {
+                        if (cancellationToken.IsCancellationRequested)
+                            break;
+                            
+                        try
+                        {
+                            await _uploadRigInfoToUserSpecifiedAddressAsync(address, data, cancellationToken);
+                        }
+                        catch (Exception ex)
+                        {
+                            ClassLogger.Warn(ex, $"Failed to sync rig info to {address}");
+                        }
+                    }
+                }, cancellationToken);
+            }
+            
+            return data;
+        }
+        catch (Exception ex)
+        {
+            ClassLogger.Error(ex, "Failed to get rig info");
+            throw;
+        }
+    }
+
+    private async Task<RadioData> GetRigDataForService(dynamic settings, CancellationToken cancellationToken)
+    {
+        return settings.ServiceType switch
+        {
+            RigBackendServiceEnum.Hamlib => await GetHamlibData(settings.Hamlib, cancellationToken),
+            RigBackendServiceEnum.FLRig => await GetFLRigData(settings.FLRig, cancellationToken),
+            RigBackendServiceEnum.OmniRig => await GetOmniRigData(settings.OmniRig, cancellationToken),
+            _ => throw new ArgumentOutOfRangeException()
+        };
+    }
+
+    private async Task<RadioData> GetHamlibData(HamlibSettings settings, CancellationToken cancellationToken)
+    {
+        if (!settings.PollAllowed)
+            throw new InvalidPollException("Poll disabled.");
 
-                if (appSettingsHamlibSettings.IsHamlibHasErrors())
-                    throw new InvalidConfigurationException(TranslationHelper.GetString(LangKeys.confhamlibfirst));
+        if (settings.IsHamlibHasErrors())
+            throw new InvalidConfigurationException(TranslationHelper.GetString(LangKeys.confhamlibfirst));
 
-                if (!_currentService.IsServiceRunning() && !appSettingsHamlibSettings.UseExternalRigctld)
-                    await _startRigctld();
-                var (ip, port) = _getRigctldIpAndPort();
-                data = await _currentService.GetAllRigInfo(appSettingsHamlibSettings.ReportRFPower,
-                    appSettingsHamlibSettings.ReportSplitInfo,
-                    CancellationToken.None,
-                    ip,
-                    port);
-                data.RigName = appSettingsHamlibSettings.SelectedRigInfo?.Model;
-                break;
-            case RigBackendServiceEnum.FLRig:
-                if (!appSettingsFLRigSettings.PollAllowed)
-                    throw new InvalidPollException("Poll disabled.");
+        if (!_currentService.IsServiceRunning() && !settings.UseExternalRigctld)
+            await _startRigctld();
+            
+        var (ip, port) = _getRigctldIpAndPort();
+        var data = await _currentService.GetAllRigInfo(
+            settings.ReportRFPower,
+            settings.ReportSplitInfo,
+            cancellationToken,
+            ip,
+            port);
+            
+        data.RigName = settings.SelectedRigInfo?.Model;
+        return data;
+    }
+
+    private async Task<RadioData> GetFLRigData(FLRigSettings settings, CancellationToken cancellationToken)
+    {
+        if (!settings.PollAllowed)
+            throw new InvalidPollException("Poll disabled.");
 
-                if (appSettingsFLRigSettings.IsFLRigHasErrors())
-                    throw new InvalidConfigurationException(TranslationHelper.GetString(LangKeys.confflrigfirst));
+        if (settings.IsFLRigHasErrors())
+            throw new InvalidConfigurationException(TranslationHelper.GetString(LangKeys.confflrigfirst));
 
-                data = await _currentService.GetAllRigInfo(appSettingsFLRigSettings.ReportRFPower,
-                    appSettingsFLRigSettings.ReportSplitInfo,
-                    CancellationToken.None,
-                    appSettingsFLRigSettings.FLRigHost,
-                    appSettingsFLRigSettings.FLRigPort);
-                break;
+        var data = await _currentService.GetAllRigInfo(
+            settings.ReportRFPower,
+            settings.ReportSplitInfo,
+            cancellationToken,
+            settings.FLRigHost,
+            settings.FLRigPort);
             
-            case RigBackendServiceEnum.OmniRig:
-                if (!appSettingsOmniSettings.PollAllowed)
-                    throw new InvalidPollException("Poll disabled.");
+        return data;
+    }
+
+    private async Task<RadioData> GetOmniRigData(OmniRigSettings settings, CancellationToken cancellationToken)
+    {
+        if (!settings.PollAllowed)
+            throw new InvalidPollException("Poll disabled.");
 
-                if (appSettingsOmniSettings.IsOmniRigHasErrors())
-                    throw new InvalidConfigurationException(TranslationHelper.GetString(LangKeys.confomnifirst));
+        if (settings.IsOmniRigHasErrors())
+            throw new InvalidConfigurationException(TranslationHelper.GetString(LangKeys.confomnifirst));
 
-                data = await _currentService.GetAllRigInfo(appSettingsFLRigSettings.ReportRFPower,
-                    appSettingsFLRigSettings.ReportSplitInfo,
-                    CancellationToken.None);
-                break;
-            default:
-                throw new ArgumentOutOfRangeException();
-        }
-
-        // finally we sync rig info to user-specified addresses.
-        foreach (var se in _syncRigInfoAddr)
-        {
-            if (string.IsNullOrWhiteSpace(se)) continue;
-            _ = _uploadRigInfoToUserSpecifiedAddressAsync(se, data,
-                CancellationToken.None);
-        }
-
+        var data = await _currentService.GetAllRigInfo(
+            _appSettings.FLRigSettings.ReportRFPower,
+            _appSettings.FLRigSettings.ReportSplitInfo,
+            cancellationToken);
+            
         return data;
     }
 
@@ -270,29 +424,26 @@
 
     public int GetPollingInterval()
     {
-        var interval = _currentService.GetServiceType() switch
-        {
-            RigBackendServiceEnum.FLRig => _appSettings.FLRigSettings.PollInterval,
-            RigBackendServiceEnum.Hamlib => _appSettings.HamlibSettings.PollInterval,
-            RigBackendServiceEnum.OmniRig =>  _appSettings.OmniRigSettings.PollInterval
-        };
-
-        if (int.TryParse(interval, out var intervalInt))
+        UpdateSettingsCache(); // Use cached values
+        
+        return _currentService.GetServiceType() switch
         {
-            if (intervalInt > 1) return intervalInt;
-            return 1;
-        }
-
-        return DefaultConfigs.RigDefaultPollingInterval;
+            RigBackendServiceEnum.FLRig => Math.Max(1, _settingsCache.FLRigPollInterval),
+            RigBackendServiceEnum.Hamlib => Math.Max(1, _settingsCache.HamlibPollInterval),
+            RigBackendServiceEnum.OmniRig => Math.Max(1, _settingsCache.OmniRigPollInterval),
+            _ => DefaultConfigs.RigDefaultPollingInterval
+        };
     }
 
     public bool GetPollingAllowed()
     {
+        UpdateSettingsCache(); // Use cached values
+        
         return _currentService.GetServiceType() switch
         {
-            RigBackendServiceEnum.FLRig => _appSettings.FLRigSettings.PollAllowed,
-            RigBackendServiceEnum.Hamlib => _appSettings.HamlibSettings.PollAllowed,
-            RigBackendServiceEnum.OmniRig => _appSettings.OmniRigSettings.PollAllowed
+            RigBackendServiceEnum.FLRig => _settingsCache.FLRigPollAllowed,
+            RigBackendServiceEnum.Hamlib => _settingsCache.HamlibPollAllowed,
+            RigBackendServiceEnum.OmniRig => _settingsCache.OmniRigPollAllowed
         };
     }
 
@@ -330,8 +481,7 @@
             
             if (backendServiceEnum == RigBackendServiceEnum.OmniRig)
             {
-                // await service.StopService(_getNewCancellationProcessToken());
-                await service.StartService(_getNewCancellationProcessToken(),draftSettings.OmniRigSettings.SelectedRig);
+                await service.StartService(_getNewCancellationProcessToken(), draftSettings.OmniRigSettings.SelectedRig);
                 await service.GetAllRigInfo(false, false, CancellationToken.None);
             }
         }
@@ -403,6 +553,7 @@
             }
             else
             {
+                ClassLogger.Debug($"Unable to Match port from rigctld args.");
                 throw new Exception(TranslationHelper.GetString(LangKeys.failextractinfo));
             }
         }
@@ -413,7 +564,7 @@
     private async Task _uploadRigInfoToUserSpecifiedAddressAsync(string url,
         RadioData data, CancellationToken token)
     {
-        var payloadI = new RadioApiCallV2
+        var payload = new RadioApiCallV2
         {
             Radio = data.RigName ?? "Unknown",
             Frequency = data.FrequencyTx,
@@ -425,10 +576,36 @@
 
         var results = await url
             .WithHeader("Content-Type", "application/json")
-            .PostStringAsync(JsonConvert.SerializeObject(payloadI), cancellationToken: token)
+            .PostStringAsync(JsonConvert.SerializeObject(payload), cancellationToken: token)
             .ReceiveString();
-
+        
         if (results != "OK")
-            throw new Exception($"Result does not return as expected: expect \"OK\" but we got {results}");
+            throw new Exception($"Expected 'OK' but got: {results}");
+    }
+
+    private void UpdateSettingsCache()
+    {
+        if (_settingsCache != null && (DateTime.Now - _lastSettingsUpdate).TotalSeconds < 5)
+            return;
+            
+        _settingsCache = new PollingSettingsCache
+        {
+            HamlibPollAllowed = _appSettings.HamlibSettings.PollAllowed,
+            FLRigPollAllowed = _appSettings.FLRigSettings.PollAllowed,
+            OmniRigPollAllowed = _appSettings.OmniRigSettings.PollAllowed,
+            HamlibPollInterval = ParsePollInterval(_appSettings.HamlibSettings.PollInterval),
+            FLRigPollInterval = ParsePollInterval(_appSettings.FLRigSettings.PollInterval),
+            OmniRigPollInterval = ParsePollInterval(_appSettings.OmniRigSettings.PollInterval),
+            CacheTime = DateTime.Now
+        };
+        
+        _lastSettingsUpdate = DateTime.Now;
+    }
+
+    private int ParsePollInterval(string interval)
+    {
+        if (int.TryParse(interval, out var intervalInt) && intervalInt > 0)
+            return intervalInt;
+        return DefaultConfigs.RigDefaultPollingInterval;
     }
 }
\ No newline at end of file
Index: src/CloudlogHelper/Services/UdpServerService.cs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CloudlogHelper/Services/UdpServerService.cs b/src/CloudlogHelper/Services/UdpServerService.cs
--- a/src/CloudlogHelper/Services/UdpServerService.cs	(revision 3d18975e0c9d167508dd0a7eaa99d2cfc5382bef)
+++ b/src/CloudlogHelper/Services/UdpServerService.cs	(revision f909e597bc891ca3e38542baa06fdb27c36b3306)
@@ -54,6 +54,32 @@
         _cts.Dispose();
     }
 
+    public string GetUdpBindingAddress()
+    {
+        try
+        {
+            var settings = _applicationSettingsService.GetCurrentSettings().UDPSettings;
+            var port = settings.UDPPort;
+            if (string.IsNullOrEmpty(port))
+            {
+                return "(?)";
+            }
+
+            if (settings.EnableConnectionFromOutside)
+            {
+                return $"(0.0.0.0:{port})";
+            }
+
+            return $"(127.0.0.1:{port})";
+        }
+        catch (Exception a)
+        {
+            ClassLogger.Error(a,"Failed to update udp listening address.");
+            return "?";
+            // _windowNotificationManagerService.SendErrorNotificationSync(a.Message);
+        }
+    }
+
     public bool IsUdpServerEnabled()
     {
         return _applicationSettingsService.GetCurrentSettings().UDPSettings.EnableUDPServer;
Index: src/CloudlogHelper/ViewModels/UserControls/StatusLightUserControlViewModel.cs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/CloudlogHelper/ViewModels/UserControls/StatusLightUserControlViewModel.cs b/src/CloudlogHelper/ViewModels/UserControls/StatusLightUserControlViewModel.cs
--- a/src/CloudlogHelper/ViewModels/UserControls/StatusLightUserControlViewModel.cs	(revision 3d18975e0c9d167508dd0a7eaa99d2cfc5382bef)
+++ b/src/CloudlogHelper/ViewModels/UserControls/StatusLightUserControlViewModel.cs	(revision f909e597bc891ca3e38542baa06fdb27c36b3306)
@@ -24,10 +24,7 @@
     /// </summary>
     private static readonly Logger ClassLogger = LogManager.GetCurrentClassLogger();
 
-    private readonly IApplicationSettingsService _applicationSettingsService;
-
     private bool _applingSettings;
-    private IInAppNotificationService _inAppNotificationService;
 
     private bool _isRigctldUsingExternal;
 
@@ -47,10 +44,8 @@
         IInAppNotificationService nw,
         CommandLineOptions cmd)
     {
-        _applicationSettingsService = ss;
         _udpServerService = uSer;
         _rigBackendManager = rigBackendManager;
-        _inAppNotificationService = nw;
         InitSkipped = cmd.AutoUdpLogUploadOnly;
         if (!InitSkipped)
         {
@@ -63,10 +58,10 @@
                 try
                 {
                     UdpServerRunningStatus = StatusLightEnum.Loading;
-                    if (_applicationSettingsService.TryGetDraftSettings(this, out var draft))
+                    if (ss.TryGetDraftSettings(this, out var draft))
                     {
                         draft!.UDPSettings.EnableUDPServer = !draft!.UDPSettings.EnableUDPServer;
-                        _applicationSettingsService.ApplySettings(this);
+                        ss.ApplySettings(this);
                     }
 
                     await Task.Delay(500);
@@ -109,10 +104,8 @@
                 switch (res.Part)
                 {
                     case ChangedPart.NothingJustClosed:
-                        _updateRigListeningAddress();
-                        break;
-                    case ChangedPart.UDPServer:
-                        _updateUdpServerListeningAddress();
+                        _updateRigInfo();
+                        _updateUdpServerInfo();
                         break;
                 }
             }).DisposeWith(disposables);
@@ -126,127 +119,23 @@
                     : StatusLightEnum.Stopped;
 
                 RigBackendRunningStatus = _rigBackendManager.IsServiceRunning()
-                                          || (_isRigctldUsingExternal && _rigBackendManager.GetServiceType() ==
-                                              RigBackendServiceEnum.Hamlib)
                     ? StatusLightEnum.Running
                     : StatusLightEnum.Stopped;
             }).DisposeWith(disposables);
         });
 
-        _updateUdpServerListeningAddress();
-        _updateRigListeningAddress();
+        _updateUdpServerInfo();
+        _updateRigInfo();
     }
 
-    private void _updateRigListeningAddress()
+    private void _updateRigInfo()
     {
-
-        var tp = _rigBackendManager.GetServiceType();
-        // Console.WriteLine($"========Current: {_rigBackendManager.GetServiceType()}");
-
-        if (tp == RigBackendServiceEnum.Hamlib)
-        {
-            BackendService = "Hamlib";
-            var hamlibSettings = _applicationSettingsService.GetCurrentSettings().HamlibSettings;
-            var ip = DefaultConfigs.RigctldDefaultHost;
-            var port = DefaultConfigs.RigctldDefaultPort;
-
-            try
-            {
-                if (hamlibSettings.UseExternalRigctld)
-                {
-                    _isRigctldUsingExternal = true;
-                    (ip, port) = IPAddrUtil.ParseAddress(hamlibSettings.ExternalRigctldHostAddress);
-                    CurrentRigBackendAddress = $"({ip}:{port})";
-                    return;
-                }
+        CurrentRigBackendAddress = _rigBackendManager.GetServiceEndpointAddress();
+        BackendService = _rigBackendManager.GetServiceType().ToString();
+    }
 
-                _isRigctldUsingExternal = false;
-
-                if (hamlibSettings.UseRigAdvanced &&
-                    !string.IsNullOrEmpty(hamlibSettings.OverrideCommandlineArg))
-                {
-                    var matchIp = Regex.Match(hamlibSettings.OverrideCommandlineArg, @"-T\s+(\S+)");
-                    if (matchIp.Success)
-                    {
-                        ip = matchIp.Groups[1].Value;
-                        ClassLogger.Debug($"Match ip from args: {ip}");
-                    }
-                    else
-                    {
-                        CurrentRigBackendAddress = "(?)";
-                        throw new Exception(TranslationHelper.GetString(LangKeys.failextractinfo));
-                    }
-
-                    var matchPort = Regex.Match(hamlibSettings.OverrideCommandlineArg, @"-t\s+(\S+)");
-                    if (matchPort.Success)
-                    {
-                        port = int.Parse(matchPort.Groups[1].Value);
-                    }
-                    else
-                    {
-                        CurrentRigBackendAddress = "(?)";
-                        throw new Exception(TranslationHelper.GetString(LangKeys.failextractinfo));
-                    }
-
-                    CurrentRigBackendAddress = $"({ip}:{port})";
-                    return;
-                }
-
-                if (hamlibSettings is { UseRigAdvanced: true, AllowExternalControl: true })
-                {
-                    CurrentRigBackendAddress = $"(0.0.0.0:{port})";
-                    return;
-                }
-
-                CurrentRigBackendAddress = $"({ip}:{port})";
-            }
-            catch (Exception a)
-            {
-                ClassLogger.Error(a,"Failed to update rig listen address.");
-                // _windowNotificationManagerService.SendErrorNotificationSync(a.Message);
-                CurrentRigBackendAddress = "(?)";
-            }
-        }
-
-        if (tp == RigBackendServiceEnum.FLRig)
-        {
-            BackendService = "FLRig";
-            var flrigSettings = _applicationSettingsService.GetCurrentSettings().FLRigSettings;
-            CurrentRigBackendAddress = $"({flrigSettings.FLRigHost}:{flrigSettings.FLRigPort})";
-        }
-        
-        if (tp == RigBackendServiceEnum.OmniRig)
-        {
-            BackendService = "OmniRig";
-            var omniRigSettings = _applicationSettingsService.GetCurrentSettings().OmniRigSettings;
-            CurrentRigBackendAddress = $"({omniRigSettings.SelectedRig})";
-        }
-    }
-
-    private void _updateUdpServerListeningAddress()
-    {
-        try
-        {
-            var settings = _applicationSettingsService.GetCurrentSettings().UDPSettings;
-            var port = settings.UDPPort;
-            if (string.IsNullOrEmpty(port))
-            {
-                CurrentUDPServerAddress = "(?)";
-                return;
-            }
-
-            if (settings.EnableConnectionFromOutside)
-            {
-                CurrentUDPServerAddress = $"(0.0.0.0:{port})";
-                return;
-            }
-
-            CurrentUDPServerAddress = $"(127.0.0.1:{port})";
-        }
-        catch (Exception a)
-        {
-            ClassLogger.Error(a,"Failed to update udp listening address.");
-            // _windowNotificationManagerService.SendErrorNotificationSync(a.Message);
-        }
+    private void _updateUdpServerInfo()
+    {
+        CurrentUDPServerAddress = _udpServerService.GetUdpBindingAddress();
     }
 }
\ No newline at end of file
